# 100-Prisoners-1-Switch-Problem
Implementation of the multithreading thought experiment in which 100 prisoners must communicate with nothing more than a single switch to escape their prison.

## Problem Description:
100 prisoners are told by their warden that they will receive a challenge. If they succeed, they all go free, but if they fail, they will never be allowed to leave. What is this, Saw? I guess we'll assume the prisoners are good people and we want to help them escape. Here is the challenge:
- There will be a switch room which contains nothing but a single switch which can be flipped on or off, though it isn't actually connected to anything. Trying to break or otherwise tamper with the switch, or trying to do anything to modify the physical state of the room itself will result in instant failure, I guess.
- The warden will decide at arbitrary times to let 1 of the 100 prisoners into the switch room. Though the order and frequency of this are not guaranteed, what *is* guaranteed is that given an unbounded number of overall visits, every individual prisoner will eventually visit the switch room an unbounded number of times. It could be that a given prisoner visits the room more than once before another prisoner gets to visit it even once, but eventually everyone will visit it.
- Only 1 prisoner may be in the switch room at a time. They can choose to flip the switch or leave it alone, and then leave. The switch will remain in that state, not being touched by any prison staff in-between visits by prisoners.
- The prisoners will be given the opportunity to talk to each other in the very beginning, before anyone sees the switch room, to form a strategy. Once the challenge is underway, prisoners will have no way to communicate with each other.
- The initial state of the switch is unknown.
- The challenge ends when any one prisoner declares, "We have all visited the switch room at least once." If the declaration is correct, then the prisoners win. If it is incorrect, they lose.

## High-Level Solution:
The idea is to assign 99 prisoners to the following task (for simplicity, it is purposely missing some crucial details which will be discussed later):
- When you enter the switch room, first ask yourself if you have ever flipped the switch before. If so, leave immediately without doing anything. If not, move on to checking the state of the switch. If the switch is currently off, flip it on and then leave. Otherwise, leave immediately without doing anything. Never ever declare that all prisoners have visited the switch room.

The 1 prisoner who is not part of the above 99 will have this special task instead:
- Keep a mental note of a counter that starts at 0. When you enter the switch room, check the state of the switch. If it is on, flip it off and increment your mental counter by 1. Otherwise, leave immediately without doing anything. You may declare that all prisoners have visited at least once when your counter reaches 99. Do NOT overcount, i.e., do not try to count beyond 99.

Again, **this solution is currently lacking crucial details.** Namely, it is not accounting for the unknown initial state. However, it is easiest to understand the two base cases (the switch started off, or the switch started on) separately before accounting for the uncertainty. **The true solution has every prisoner in the regular group try to flip the switch on exactly twice, while the designated counter counts to 198.** We'll work our way to understanding that thinking gradually.

## More Detailed Breakdown:
The fundamentals revolve around the problem of communicating the count with nothing but the switch, when the switch is only binary in state. Basically, one of those two states will need to communicate that a prisoner has just visited, and the other state will need to comminucate that that fact has been acknowledged and taken into account. Then, we need a sort of resident monitor (RM) to be in charge of this "acking"; they become the one keeping track of the total count of prisoners who have visited, and also must communicate back to the others when they are ready for someone to communicate a visit to them again. They will be the only one who knows for sure when every prisoner has visited at least once, given that everyone else will not flip the switch on more than absolutely necessary. However, this comes with a dangerous downside; if the RM expects too high of a number, it is possible that they deadlock, waiting forever for an increment that will never happen because all other prisoners have hit their maximum number of flips. This is why the RM has a rule to not overcount. They should declare the challenge complete as soon as the minimum count required is reached.

Next, let us consider the two base cases (switch starts on versus switch starts off) separately. This means each prisoner will only be flipping the switch once, with the RM trying to count to 99. But more generally, we want to consider what it looks like right before and after the final prisoner has flipped the switch on (this will make it easier to compare to the true solution later):
1. *Switch starts on*: In this case, if one of the 99 from the regular group visits before the first time the RM visits, they will have to leave without doing anything. This means that the RM's first visit, in which they turn the switch off for the first time, will *NOT* correspond to an actual prisoner having visited. Because they have no way of knowing that, they will increment their counter anyway. When the counter reaches 99, it actually represents that only 98 of the regular group has actually visited. `98 prisoners * 1 on state + 1 prisoner * 0 on states + 1 initial on state = 99 on states counted.` So it turns out that counting to 99 isn't sufficient! The RM would have needed to count to 100. In fact, assuming a 50/50 chance of the switch starting in the on/off position, if the RM declares that everyone has visited upon counting 99, then there is a 50/50 chance they are correct/wrong! How terrible.
2. *Switch starts off*: Okay, so then this is the case in which counting to 99 would be correct. This is because the first time the RM sees the switch on, it definitely represents another prisoner trying to communicate their visit. Right before the last prisoner has flipped the switch, `98 prisoners * 1 on state + 1 prisoner * 0 on states = 98 on states counted,` so counting to 99 will be sufficient.

However, the problem says that we don't know which it could be. So then, to be safe, shouldn't we just count to 100? But then, let's examine the deadlock scenario for each case, pretending that the RM wants to count to 100 instead, to be safe. We generalize the description of when the deadlock situation occurs to be when all 99 of the regular group have finished reporting their visits but the RM is still expecting to count higher. We've determined that counting to 99 isn't safe, and want to use 100 instead, but this is what happens with the deadlock scenario:
1. *Switch starts on*: When the 99th of the regular group flips the switch on, the RM's next visit will increment the counter to 100 as they turn the switch back off again. This seems to work just fine. `99 prisoners * 1 on state + 1 initial on state = 100 on states counted.` Since 100 was reached, the RM declares that every prisoner has visited the room at least once, and the answer is correct.
2. *Switch starts off*: When the 99th of the regular group flips the switch on, the RM's next visit will increment the counter to 99 as they turn the switch back off again. `99 prisoners * 1 on state = 99 on states counted.` The RM is expecting to count to 100. However, according to the rules for the regular group, no one will ever flip the switch back on again, because they have all satisfied their tasks. Any time the RM revisits the room, the switch will still be off. They can never declare for sure that everyone is finished, because it is possible that the switch started in the on position, and the 99th person just still hasn't flipped it on yet. As time passes and nothing changes, the RM can reason that the probability that a prisoner still hasn't visited is getting lower and lower, meaning that if they risked making the claim that all 100 had visited, the odds are growing in their favor. However, it is still possible to be wrong, and the exact odds are uncertain. So technically, the RM should wait till they count to 100 to be sure, but that will never happen.

So we see this paradox that counting to 99 may not work in the case that the switch started in the on position (there is a chance for a false positive - claiming that everyone visited when they did not), and counting to 100 may not work in the case that the switch started in the off position (there is a chance for a false negative - thinking that not everyone visited yet even though they did).

Thus we come to the true solution, in which everyone in the regular group attempts to communicate exactly *two* visits to the RM. To explore the implications on the RM's desired count, let us consider the largest count in which the condition of everyone visiting at least once is still unsatisfied. As we somewhat generalized earlier, it will happen when exactly 98 of the regular group have communicated their visits - this time two - but one person still hasn't communicated *any*.
1. *Switch starts on*: `98 prisoners * 2 on states + 1 prisoner * 0 on states + 1 initial on state = 197 on states counted.` The 198th on state counted will guarantee that everyone visited at least once.
2. *Switch starts off*: `98 prisoners * 2 on states + 1 prisoner * 0 on states = 196 on states counted.` The 197th on state counted will guarantee that everyone visited at least once.

Okay, so like before, we would have to pick the larger number to avoid a false positive. That means the RM is trying to count to 198. But will this repeat the issue of introducing the possibility of the deadlock scenario? Recall that it will happen when all 99 of the regular group have completed their tasks - in this case, reporting exactly two visits - but the RM is still expecting to count more.
1. *Switch starts on*: `99 prisoners * 2 on states + 1 initial on state = 199 on states counted.`
2. *Switch starts off*: `99 prisoners * 2 on states = 198 on states counted.`

So 198 works!

It appears that for two potiential initial states which can introduce an offset in the count between 0-1, the prisoners must communicate, redundantly, at least two visits to get the minimum and maximum bounds to align. Further redundancy would widen the range of tolerance between the minimum and maximum, but it's completely unnecessary, so they should just stop at two per prisoner, with the expected count being precisely 198.

Addendum: It turns out there is a special case in which the RM walks in for the first time and see the switch turned off; this can only have been the case if the switch started off and no one else has entered yet. Otherwise, it would have been flipped on. The RM is at least aware of the first time they entered, so this is a valid way to identify the starting state of the switch, though the likelihood of it happening is probably pretty low. When they know for sure that the switch started off, they can actually be guaranteed that a count of 197 is sufficient.
